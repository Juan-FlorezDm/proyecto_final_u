<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito de Compras</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link th:href="@{/css/tienda.css}" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
 

   <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" th:href="@{/cliente/tienda}">Tienda de Ropa</a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3" sec:authorize="isAuthenticated()">
                    üëã Hola, <span sec:authentication="name">Usuario</span>
                </span>
                
                <!-- Bot√≥n del Carrito -->
                <a class="btn btn-outline-light btn-sm me-2 position-relative" 
                   th:href="@{/cliente/tienda}">
                    üè™Tienda
                    <span th:if="${carritoCount != null and carritoCount > 0}" 
                          class="position-absolute top-0 start-100 translate-middle badge rounded-pill">
                        <span th:text="${carritoCount}">0</span>
                        <span class="visually-hidden">items en el carrito</span>
                    </span>
                </a>
                
                <a class="nav-link me-3" th:href="@{/cliente/facturas}">üìÑ Facturas</a>
                <a class="btn btn-outline-light btn-sm" th:href="@{/logout}">üö™ Salir</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
       
<div class="container mt-4">
         <div th:if="${success}" class="alert alert-success alert-dismissible fade show">
            <span th:text="${success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <h2>üõí Carrito de Compras</h2>
        
        <div th:if="${not #lists.isEmpty(carrito.items)}">
            <!-- Items del carrito -->
            <div class="table-responsive">
                <table class="table table-custom">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Precio Unitario</th>
                            <th>Cantidad</th>
                            <th>Subtotal</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="item : ${carrito.items}" class="cart-item" 
                            th:data-precio="${item.precioUnitario}">
                            <td>
                                <div class="product-info">
                                    <strong th:text="${item.producto.nombre}"></strong><br>
                                    <small class="text-muted">  Talla: <span th:text="${item.talla}"></span></small><br>
                                    <small class="text-muted" th:text="${item.producto.categoria}"></small>
                                </div>
                            </td>
                            <td class="price" th:text="'$' + ${#numbers.formatDecimal(item.precioUnitario, 1, 2)}">$0.00</td>
                            <td>
                                <form th:action="@{/cliente/carrito/actualizar}" method="post" class="quantity-form">
                                    <input type="hidden" name="productoId" th:value="${item.producto.id}">
                                    <input type="hidden" name="talla" th:value="${item.talla}">
                                    <div class="quantity-controls">
                                        <input type="number" name="cantidad" th:value="${item.cantidad}" 
                                            min="1" max="99" class="form-control quantity-input"
                                            onchange="actualizarSubtotal(this)">
                                    </div>
                                </form>
                            </td>
                            <td class="subtotal" th:text="'$' + ${#numbers.formatDecimal(item.subtotal, 1, 2)}">$0.00</td>
                            <td>
                                <form th:action="@{/cliente/carrito/eliminar/{productoId}(productoId=${item.producto.id}, talla=${item.talla})}" 
                                      method="post" class="delete-form">
                                    <button type="submit" class="btn btn-delete" title="Eliminar del carrito">
                                        üóëÔ∏è
                                    </button>
                                </form>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Resumen del carrito -->
            <div class="row mt-4">
                <div class="col-md-6 offset-md-6">
                    <div class="summary-card">
                        <div class="card-body">
                            <h5 class="card-title">üìã Resumen de Compra</h5>
                            <div class="summary-item">
                                <span>Total Items:</span>
                                <span class="total-items" id="total-items">[[${carrito.totalItems}]]</span>
                            </div>
                            <div class="summary-total">
                                <strong>Total a Pagar:</strong>
                                <strong class="total-amount" id="total-pagar">$<span id="total-pagar-amount">[[${#numbers.formatDecimal(carrito.total, 1, 2)}]]</span></strong>
                            </div>
                            <div class="payment-actions">
                                <a th:href="@{/cliente/pago}" class="btn btn-payment" onclick="verificarActualizacion(event)">
                                    üí≥ Proceder al Pago
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Carrito vac√≠o -->
        <div th:if="${#lists.isEmpty(carrito.items)}" class="empty-cart">
            <div class="empty-state">
                <div class="empty-icon">üõí</div>
                <h4>Tu carrito est√° vac√≠o</h4>
                <p class="text-muted">Agrega algunos productos desde la tienda</p>
                <a th:href="@{/cliente/tienda}" class="btn btn-primary btn-empty">üè™ Ir a la Tienda</a>
            </div>
        </div>             
</div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Script para actualizaci√≥n en tiempo real -->
    <script>
        // Funci√≥n para actualizar el subtotal y enviar al servidor
        function actualizarSubtotal(input) {
            const cantidad = parseInt(input.value);
            const fila = input.closest('.cart-item');
            const precioUnitario = parseFloat(fila.getAttribute('data-precio'));
            const subtotalElement = fila.querySelector('.subtotal');
            
            // Calcular nuevo subtotal
            const nuevoSubtotal = precioUnitario * cantidad;
            
            // Actualizar el elemento del subtotal
            subtotalElement.textContent = '$' + nuevoSubtotal.toFixed(2);
            
            // Recalcular el total general
            calcularTotalGeneral();
            
            // Validar cantidad
            if (cantidad < 1) {
                input.value = 1;
                actualizarSubtotal(input);
                return;
            }
            if (cantidad > 99) {
                input.value = 99;
                actualizarSubtotal(input);
                return;
            }
            
            // Enviar actualizaci√≥n autom√°ticamente al servidor
            actualizarEnServidor(input);
        }

        // Funci√≥n para calcular el total general del carrito
        function calcularTotalGeneral() {
            const items = document.querySelectorAll('.cart-item');
            let totalItems = 0;
            let totalPagar = 0;
            
            items.forEach(item => {
                const cantidadInput = item.querySelector('.quantity-input');
                const precioUnitario = parseFloat(item.getAttribute('data-precio'));
                const cantidad = parseInt(cantidadInput.value);
                
                totalItems += cantidad;
                totalPagar += precioUnitario * cantidad;
            });
            
            // Actualizar los elementos del resumen
            document.getElementById('total-items').textContent = totalItems;
            document.getElementById('total-pagar-amount').textContent = totalPagar.toFixed(2);
        }

        // Funci√≥n para enviar la actualizaci√≥n al servidor
        function actualizarEnServidor(input) {
            const form = input.closest('.quantity-form');
            const formData = new FormData(form);
            
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la actualizaci√≥n');
                }
                return response.text();
            })
            .then(() => {
                console.log('Cantidad actualizada en el servidor');
            })
            
        }

        // Funci√≥n para mostrar mensajes
        function showMessage(message) {
            // Crear o usar un contenedor de mensajes existente
            let messageContainer = document.getElementById('dynamic-messages');
            if (!messageContainer) {
                messageContainer = document.createElement('div');
                messageContainer.id = 'dynamic-messages';
                document.querySelector('.container.mt-4').prepend(messageContainer);
            }
            
            const alert = document.createElement('div');
            alert.className = 'alert alert-info alert-dismissible fade show';
            alert.innerHTML = `
                <span>${message}</span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            messageContainer.appendChild(alert);
            
            // Auto-eliminar despu√©s de 3 segundos
            setTimeout(() => {
                alert.remove();
            }, 3000);
        }

        // Funci√≥n para verificar actualizaci√≥n antes de proceder al pago
        function verificarActualizacion(event) {
            // Peque√±a espera para asegurar que las actualizaciones se completen
            setTimeout(() => {
                // Continuar con la redirecci√≥n normal
                window.location.href = event.target.href;
            }, 500);
        }

        // Inicializar cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            // Part√≠culas de fondo
            

            // Agregar event listeners a todos los inputs de cantidad
            const quantityInputs = document.querySelectorAll('.quantity-input');
            quantityInputs.forEach(input => {
                // Evento para cambio en tiempo real
                input.addEventListener('input', function() {
                    actualizarSubtotal(this);
                });
                
                // Evento para cambio con las flechas
                input.addEventListener('change', function() {
                    actualizarSubtotal(this);
                });
                
                // Validaci√≥n inicial
                if (input.value < 1) input.value = 1;
                if (input.value > 99) input.value = 99;
            });

            // Confirmaci√≥n para eliminar items
            const deleteButtons = document.querySelectorAll('.btn-delete');
            deleteButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    if (!confirm('¬øEst√°s seguro de que quieres eliminar este producto del carrito?')) {
                        e.preventDefault();
                    }
                });
            });

            // Efecto hover en items del carrito
            const cartItems = document.querySelectorAll('.cart-item');
            cartItems.forEach(item => {
                item.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateX(5px)';
                });
                
                item.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateX(0)';
                });
            });

            // Inicializar el c√°lculo total
            calcularTotalGeneral();
        });

        // Prevenir env√≠o del formulario si la cantidad no es v√°lida
        document.querySelectorAll('.quantity-form').forEach(form => {
            form.addEventListener('submit', function(e) {
                const input = this.querySelector('.quantity-input');
                if (input.value < 1 || input.value > 99) {
                    e.preventDefault();
                    alert('La cantidad debe estar entre 1 y 99');
                    input.focus();
                }
            });
        });
    </script>
</body>
</html>