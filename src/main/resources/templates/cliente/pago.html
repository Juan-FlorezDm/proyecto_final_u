<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito de Compras</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link th:href="@{/css/tienda.css}" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <!-- Efecto de partÃ­culas de fondo -->
    <div class="bg-particles" id="particles"></div>

    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" th:href="@{/cliente/tienda}">Tienda de Ropa</a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3" sec:authorize="isAuthenticated()">
                    ðŸ‘‹ Hola, <span sec:authentication="name">Usuario</span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8">
                <!-- Resumen del pedido -->
                <div class="summary-card">
                    <div class="card-header">
                        <h4>Resumen de tu Pedido</h4>
                    </div>
                    <div class="card-body">
                        <div th:each="item : ${carrito.items}" class="order-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="product-details">
                                    <strong th:text="${item.producto.nombre}"></strong>
                                    <div class="product-meta">
                                        <small class="text-muted">Talla: <span th:text="${item.talla}"></span></small>
                                        <small class="text-muted">Cantidad: <span th:text="${item.cantidad}"></span></small>
                                    </div>
                                </div>
                                <span class="item-subtotal" th:text="'$' + ${#numbers.formatDecimal(item.subtotal, 1, 2)}"></span>
                            </div>
                        </div>
                        <hr class="divider">
                        <div class="order-total">
                            <div class="d-flex justify-content-between">
                                <strong>Total a Pagar:</strong>
                                <strong class="total-amount" th:text="'$' + ${#numbers.formatDecimal(carrito.total, 1, 2)}"></strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <!-- Formulario de pago -->
                <div class="payment-card">
                    <div class="card-header">
                        <h5>ðŸ’³ InformaciÃ³n de Pago</h5>
                    </div>
                    <div class="card-body">
                        <form id="payment-form">
                            <div id="payment-element">
                                <!-- Stripe Payment Element will be inserted here -->
                            </div>
                            
                            <button id="submit" class="btn btn-payment w-100 mt-3">
                                <div class="spinner hidden" id="spinner"></div>
                                <span id="button-text">
                                    ðŸš€ Pagar $<span th:text="${#numbers.formatDecimal(carrito.total, 1, 2)}"></span>
                                </span>
                            </button>
                            
                            <div id="payment-message" class="hidden mt-3"></div>
                        </form>
                        
                        <div class="text-center mt-3">
                            <a class="btn btn-outline-light btn-sm me-2 position-relative" th:href="@{/cliente/Carrito}">Volver al carrito</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ConfiguraciÃ³n de Stripe
        const stripe = Stripe('[[${stripePublicKey}]]');
        
        // Usar el clientSecret del modelo
        const clientSecret = '[[${clientSecret}]]';
        
        let elements;
        
        // Inicializar el formulario de pago
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                if (!clientSecret) {
                    showMessage('Error: No se pudo inicializar el pago');
                    return;
                }
                
                // PartÃ­culas de fondo
                initParticles();
                
                const appearance = {
                    theme: 'night',
                    variables: {
                        colorPrimary: '#7c3aed',
                        colorBackground: '#1a1a1a',
                        colorText: '#ffffff',
                        colorDanger: '#ef4444',
                        fontFamily: 'Inter, system-ui, sans-serif',
                        spacingUnit: '4px',
                        borderRadius: '8px'
                    }
                };
                
                elements = stripe.elements({ 
                    appearance, 
                    clientSecret,
                    loader: 'always'
                });
                
                const paymentElement = elements.create("payment", {
                    layout: "tabs"
                });
                
                paymentElement.mount("#payment-element");
                
            } catch (err) {
                console.error('Error:', err);
                showMessage('Error al inicializar el pago: ' + err.message);
            }
        });
        
        // Manejar el envÃ­o del formulario
        document.querySelector('#payment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            setLoading(true);
            
            try {
                const { error } = await stripe.confirmPayment({
                    elements,
                    confirmParams: {
                        return_url: window.location.origin + '/cliente/pago/exito',
                    },
                });
                
                if (error) {
                    showMessage(error.message);
                    setLoading(false);
                }
            } catch (err) {
                console.error('Error:', err);
                showMessage('Error al procesar el pago: ' + err.message);
                setLoading(false);
            }
        });
        
        // Funciones de utilidad
        function setLoading(isLoading) {
            const submit = document.querySelector("#submit");
            const spinner = document.querySelector("#spinner");
            const buttonText = document.querySelector("#button-text");
            
            if (isLoading) {
                submit.disabled = true;
                spinner.classList.remove("hidden");
                buttonText.classList.add("hidden");
            } else {
                submit.disabled = false;
                spinner.classList.add("hidden");
                buttonText.classList.remove("hidden");
            }
        }
        
        function showMessage(messageText) {
            const messageContainer = document.querySelector("#payment-message");
            messageContainer.classList.remove("hidden");
            messageContainer.textContent = messageText;
            messageContainer.className = 'alert alert-danger mt-3';
            
            setTimeout(() => {
                messageContainer.classList.add("hidden");
                messageContainer.textContent = "";
            }, 5000);
        }

        // PartÃ­culas de fondo
        function initParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 12;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                const size = Math.random() * 50 + 15;
                const posX = Math.random() * 100;
                const posY = Math.random() * 100;
                const delay = Math.random() * 5;
                
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.left = `${posX}%`;
                particle.style.top = `${posY}%`;
                particle.style.animationDelay = `${delay}s`;
                particle.style.opacity = Math.random() * 0.15 + 0.05;
                
                particlesContainer.appendChild(particle);
            }
        }
    </script>
</body>
</html>