<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda - Cliente</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link th:href="@{/css/tienda.css}" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" th:href="@{/cliente/tienda}">Tienda de Ropa</a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3" sec:authorize="isAuthenticated()">
                    ðŸ‘‹ Hola, <span sec:authentication="name">Usuario</span>
                </span>
                
                <!-- BotÃ³n del Carrito -->
                <a class="btn btn-outline-light btn-sm me-2 position-relative" 
                   th:href="@{/cliente/Carrito}">
                    ðŸ›’Carrito
                    <span th:if="${carritoCount != null and carritoCount > 0}" 
                          class="position-absolute top-0 start-100 translate-middle badge rounded-pill">
                        <span th:text="${carritoCount}">0</span>
                        <span class="visually-hidden">items en el carrito</span>
                    </span>
                </a>
                
                <a class="nav-link me-3" th:href="@{/cliente/facturas}">ðŸ“„ Facturas</a>
                <a class="btn btn-outline-light btn-sm" th:href="@{/logout}">ðŸšª Salir</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        

        <!-- Productos -->
        <div class="row" th:if="${not #lists.isEmpty(productos)}">
            <div class="col-12">
                <h4 class="mb-3">Productos Disponibles</h4>
            </div>
            
            <div th:each="producto : ${productos}" class="col-md-4 mb-4">
                <div class="card h-100">
                    <!-- Imagen del producto -->
                    <div th:if="${producto.imagenUrl != null and producto.imagenUrl != ''}" 
                         class="card-img-top-container">
                        <img th:src="${producto.imagenUrl}" class="card-img-top" 
                             th:alt="${producto.nombre}">
                    </div>
                    <div th:unless="${producto.imagenUrl != null and producto.imagenUrl != ''}" 
                         class="card-img-top-container">
                        <span class="text-muted">Sin imagen</span>
                    </div>
                    
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title" th:text="${producto.nombre}">Nombre del producto</h5>
                        <p class="card-text flex-grow-1" th:text="${producto.descripcion}">DescripciÃ³n del producto</p>
                        
                        <div class="mt-auto">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="h5 text-primary mb-0" 
                                      th:text="'$' + ${#numbers.formatDecimal(producto.precio, 1, 2)}">
                                    $0
                                </span>
                                <span class="badge bg-secondary" th:text="${producto.categoria}">
                                    CategorÃ­a
                                </span>
                            </div>
                            
                            <!-- Stock total -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <small class="text-muted" th:if="${producto.stockTotal > 0}">
                                    Stock: <span th:text="${producto.stockTotal}">0</span>
                                </small>
                                <small class="text-danger" th:if="${producto.stockTotal == 0}">
                                    Agotado
                                </small>
                            </div>
                            
                            <!-- Selector de talla -->
                            <div class="mb-2" th:if="${producto.stockTotal > 0}">
                                <label th:for="'talla_' + ${producto.id}" class="form-label">
                                    Talla
                                </label>
                                <select th:id="'talla_' + ${producto.id}" th:name="talla" 
                                        class="form-select" required>
                                    <option value="">Seleccionar talla</option>
                                    <option th:each="tallaItem : ${producto.tallas}" 
                                            th:if="${tallaItem.stock > 0}"
                                            th:value="${tallaItem.talla}"
                                            th:text="${tallaItem.talla + ' (Stock: ' + tallaItem.stock + ')'}">
                                    </option>
                                </select>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <form th:action="@{/cliente/carrito/agregar}" method="post" class="d-grid">
                                    <input type="hidden" name="productoId" th:value="${producto.id}">
                                    <input type="hidden" name="cantidad" value="1">
                                    <input type="hidden" name="talla" 
                                           th:id="'tallaSeleccionada_' + ${producto.id}">
                                    <button th:if="${producto.stockTotal > 0}" type="submit" 
                                            class="btn btn-primary" 
                                            th:onclick="'return setTalla(' + ${producto.id} + ')'">
                                        ðŸ›’ Agregar al Carrito
                                    </button>
                                    <button th:if="${producto.stockTotal == 0}" 
                                            class="btn btn-secondary" disabled>
                                        No Disponible
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mensaje si no hay productos -->
        <div class="row" th:if="${#lists.isEmpty(productos)}">
            <div class="col-12">
                <div class="alert alert-warning text-center">
                    <h4>ðŸ˜” No hay productos disponibles</h4>
                    <p>Por el momento no contamos con productos en stock.</p>
                    <a th:href="@{/}" class="btn btn-primary mt-2">ðŸ”„ Recargar</a>
                </div>
            </div>
        </div>
    </div>

   

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Script para capturar la talla seleccionada -->
    <script>
    function setTalla(productoId) {
        var selectTalla = document.getElementById('talla_' + productoId);
        var inputTalla = document.getElementById('tallaSeleccionada_' + productoId);
        
        if (selectTalla && selectTalla.value) {
            inputTalla.value = selectTalla.value;
            return true;
        } else {
            alert('Por favor selecciona una talla');
            return false;
        }
    }

    // Agregar event listener a todos los formularios
    document.addEventListener('DOMContentLoaded', function() {
        var forms = document.querySelectorAll('form');
        forms.forEach(function(form) {
            form.addEventListener('submit', function(event) {
                var productoId = form.querySelector('input[name="productoId"]').value;
                if (!setTalla(productoId)) {
                    event.preventDefault();
                }
            });
        });
    });
    </script>
</body>
</html>